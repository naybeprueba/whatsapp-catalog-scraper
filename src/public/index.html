<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Catalog Scraper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #25D366;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <div class="flex items-center gap-3">
        <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
        <div>
          <h1 class="text-2xl font-bold">WhatsApp Catalog Scraper</h1>
          <p class="text-green-100 text-sm">Extrae productos de catálogos públicos de WhatsApp Business</p>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- Form Section -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Ingresa la URL del catálogo</h2>
      <form id="scrapeForm" class="flex flex-col sm:flex-row gap-4">
        <div class="flex-1">
          <input 
            type="url" 
            id="catalogUrl" 
            placeholder="https://wa.me/c/56964151927"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition"
            required
          >
          <p class="text-gray-500 text-xs mt-2">Ejemplo: https://wa.me/c/NUMERO</p>
        </div>
        <button 
          type="submit" 
          id="submitBtn"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold px-8 py-3 rounded-lg transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="btnText">Extraer Catálogo</span>
          <div id="btnLoader" class="loader hidden"></div>
        </button>
      </form>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
      <p id="errorText"></p>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden">
      <!-- Stats -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
          <div>
            <h3 class="text-lg font-semibold text-gray-800">Resultados</h3>
            <p class="text-gray-500 text-sm">
              <span id="productCount">0</span> productos encontrados
            </p>
          </div>
          <div class="flex gap-3">
            <button 
              id="exportJsonBtn"
              class="bg-blue-500 hover:bg-blue-600 text-white font-medium px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Descargar JSON
            </button>
            <button 
              id="exportCsvBtn"
              class="bg-purple-500 hover:bg-purple-600 text-white font-medium px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Descargar CSV
            </button>
          </div>
        </div>
      </div>

      <!-- Products Table -->
      <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Imagen</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nombre</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Precio</th>
              </tr>
            </thead>
            <tbody id="productsTableBody" class="divide-y divide-gray-200">
              <!-- Products will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden bg-white rounded-xl shadow-md p-12 text-center">
        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">No se encontraron productos</h3>
        <p class="text-gray-500">No pudimos extraer productos de este catálogo. Verifica que la URL sea correcta.</p>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
    <div class="container mx-auto px-4 text-center text-sm">
      <p>WhatsApp Catalog Scraper - Solo para catálogos públicos</p>
      <p class="text-gray-500 mt-1">Esta herramienta no requiere acceso a WhatsApp, solo extrae información pública.</p>
    </div>
  </footer>

  <script>
    // State
    let currentProducts = [];

    // DOM Elements
    const form = document.getElementById('scrapeForm');
    const urlInput = document.getElementById('catalogUrl');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnLoader = document.getElementById('btnLoader');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const resultsSection = document.getElementById('resultsSection');
    const productCount = document.getElementById('productCount');
    const productsTableBody = document.getElementById('productsTableBody');
    const emptyState = document.getElementById('emptyState');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    // Event Listeners
    form.addEventListener('submit', handleSubmit);
    exportJsonBtn.addEventListener('click', exportToJson);
    exportCsvBtn.addEventListener('click', exportToCsv);

    // Handle form submission
    async function handleSubmit(e) {
      e.preventDefault();
      
      const url = urlInput.value.trim();
      if (!url) return;

      setLoading(true);
      hideError();
      hideResults();

      try {
        const response = await fetch('/api/scrape', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ url })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Error al extraer el catálogo');
        }

        currentProducts = data.products || [];
        displayResults(currentProducts);
      } catch (error) {
        showError(error.message);
      } finally {
        setLoading(false);
      }
    }

    // Display results
    function displayResults(products) {
      resultsSection.classList.remove('hidden');
      productCount.textContent = products.length;

      if (products.length === 0) {
        emptyState.classList.remove('hidden');
        productsTableBody.innerHTML = '';
        return;
      }

      emptyState.classList.add('hidden');
      productsTableBody.innerHTML = products.map(product => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4">
            ${product.imageUrl 
              ? `<img src="${escapeHtml(product.imageUrl)}" alt="${escapeHtml(product.name)}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23e5e7eb%22%3E%3Crect width=%2224%22 height=%2224%22/%3E%3C/svg%3E'">`
              : `<div class="w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>`
            }
          </td>
          <td class="px-6 py-4 font-medium text-gray-900">${escapeHtml(product.name || 'Sin nombre')}</td>
          <td class="px-6 py-4 text-gray-600 max-w-xs truncate">${escapeHtml(product.description || '-')}</td>
          <td class="px-6 py-4 text-gray-900 font-semibold">${escapeHtml(product.price || '-')}</td>
        </tr>
      `).join('');
    }

    // Export functions
    async function exportToJson() {
      if (currentProducts.length === 0) return;

      try {
        const response = await fetch('/api/export/json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ products: currentProducts })
        });

        const blob = await response.blob();
        downloadBlob(blob, 'catalogo-whatsapp.json');
      } catch (error) {
        showError('Error al exportar JSON');
      }
    }

    async function exportToCsv() {
      if (currentProducts.length === 0) return;

      try {
        const response = await fetch('/api/export/csv', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ products: currentProducts })
        });

        const blob = await response.blob();
        downloadBlob(blob, 'catalogo-whatsapp.csv');
      } catch (error) {
        showError('Error al exportar CSV');
      }
    }

    function downloadBlob(blob, filename) {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    // UI helpers
    function setLoading(isLoading) {
      submitBtn.disabled = isLoading;
      btnText.textContent = isLoading ? 'Extrayendo...' : 'Extraer Catálogo';
      btnLoader.classList.toggle('hidden', !isLoading);
    }

    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.remove('hidden');
    }

    function hideError() {
      errorMessage.classList.add('hidden');
    }

    function hideResults() {
      resultsSection.classList.add('hidden');
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
